---
marp: true
---

<!-- page_number: true -->
<!-- $theme: defalut -->
<!-- $size: 16:9 -->

FY19 VORTEX FUNトレーニング
Pythonスキルアップチーム勉強会
==

## 第4回
2019.12.19

---

本日のアジェンダ
=

django
startprojectとstartappの違い




model
adminuser





---

---

webアプリケーションとは（おさらい）
==
- webブラウザで利用できるアプリケーションのこと
- 何かを入力してその結果が反映されるようなwebサイトはwebアプリと呼べる
  - webメール、ECサイト、ブログ（の管理画面）、クラウド家計簿、などなど
- コンテンツ（文章、写真など動きのないもの）が置いてあるだけのwebサイトはwebアプリとは呼ばない

---

webアプリケーションの歴史
==
### 動きのない時代
- HTMLを読み込んで表示するだけ
- 文字と絵を表示するだけのwebページが主流
### CGIの時代
- webサーバ内でPerlスクリプトを動かして、表示するたびに変化のあるwebページが出来るように
  - アクセスカウンター、掲示板など
- javascriptは誕生していたが、ページを装飾する程度にしか使われていなかった

---

webアプリケーションの歴史
==
### アプリケーションサーバの時代
- データベースをJava等から利用し、動的にHTMLを作成できるように
  - ユーザーの入力や指示に応じてページを変更できるようになった
- 業務アプリやECサイトなどが劇的に発展した
### モダンwebアプリの時代
- Ajaxが登場、ページの表示とサーバアクセスが別タイミングに
- webブラウザ上でjavascript製のアプリが直接稼働するようになった
- webサーバは、HTML/CSS/スクリプトとデータベースを提供するように　

---

webサーバがデータベースを提供するって？
==



モダンwebアプリの構造
==


---

なぜwebAPIなのか
webAPIの種類
自サービスのデータベースだけを提供したい場合がある
天気予報とか、為替とか
マッシュアップに必要
モダンwebに必要


---


RESTAPIとは
==
- URLを使ってデータベースにアクセスできる仕組み
> 本当はもっと細かい話があるのですが今回は割愛します
- HTTPメソッドで、データの読み書き・更新・削除（CRUD)を実現する 
  - GETで読み出し、POSTで書き込み、PUTで更新、DELETEで削除
#### なぜRESTAPIが必要なのか
- web経由でデータベースにアクセスする場合、DBのポートをインターネット経由で開けるわけにはいかない
  - SQLは自由度が高いので危険
  - パスワード認証しかない

---

RESTAPIの例
==
- こんな感じの名言データベースがあったとする

|id|quote|author|
|:-|:-|:-|
|1|明日死ぬかのように生きよ。永遠に生きるかのように学べ|ガンジー|
|2|10%の才能と20%の努力、30%の臆病さと、残る40%は、運、だろうな|デューク東郷|
|3|自分で薪を割れ、二重に温まる|フォード|

---

RESTAPIの例
==
### RESTAPIのURLが http://kakugen.com だった場合

- idが1番の格言を読み込みたい場合
```
curl http://kaugen.com/quote/1
```

- 格言を追加したい場合
```
curl -X POST -d '{"quote":"talk is cheap.show me the code.","author":"トーバルズ"}' http://kaugen.com/quote/1
```
> ほとんどのRESTAPIでは、idは自動で付与されます

---

---

webAPIの紹介
==

---

ちゃんとしたwebアプリを作るのは結構大変
==
#### 入力された文字をチェックしないといけない
- フリガナの欄にちゃんとカタカナを使っているか
- メアドや電話番号のフォーマットは正しいか、などなど
#### セキュリティの問題
- 存在しないURLを叩かれたときに弾く処理がいる
- フォームの文字列を使ってSQLを叩く場合、SQLインジェクションされる可能性がある
#### 提携処理
- 商品一覧をDBから取得してHTMLを作成してwebサーバに配置して・・・・
 ログインしてるかどうかの確認
 よく使われる機能（データの管理画面とか）を１から作るの・・
---




webアプリケーションフレームワークとは
==
- 最小限の労力でwebアプリを開発できるようにする仕組み
### 「当たり前のこと」を全部勝手にやってくれる
- URLの定義と、そこへアクセスされたときの処理を完結に書ける
- フォームに入力された文字の書式チェック
- データベースは、SQLではなくPythonオブジェクトとして取り扱う
- ログインしていない場合、自動でログイン画面にリダイレクト
- 一覧表のページをDBのテーブルから自動生成
- 存在しないURLへのアクセスに404を返す
- データベースの管理画面を提供

---

Python製webフレームワーク
==
### bottle
- 一本のPythonコードだけでできた、超軽量フレームワーク
- データベース機能は持っていないのでSQLを使う必要がある
### flask
- bottleより高機能なフレームワーク
- 最低限の機能だけ持ち、必要になった機能は跡から追加するスタイル
- githubでのPython webフレームワーク人気度No.1
- Netflixなどで利用されている

---

django（ジャンゴ）の紹介
==
- webアプリに必要な機能をほぼ全て盛り込んだ、重量級フレームワーク
- 簡易的なwebサーバを持っていて、開発物をすぐにテストできる
- ユーザー認証機能を組み込んでいるので、ログインが必要なアプリも割とすぐ書ける
- データベースは組み込み済み。もちろん、MySQLなども使える
- データベースをPythonのオブジェクトとして扱える、ORマッパーを持つ
  - データベースの定義にも取り扱いにもSQLを一切使わない
- URLと処理の紐付けが非常に簡単
- HTML作成を単純化する強力なテンプレート機能がある
- RESTAPIを簡単に作成出来るdjango rest frameworkを提供
- Instagramなどで利用されている

---

django rest frameworkの紹介
==
- djangoにRESTAPI機能を追加するフレームワーク 
- djangoに追加しているだけなので、通常のサイトの作成ももちろん可能
  - というか、通常のサイトにRESTAPIを追加するイメージ
- djnago同様、pipで簡単にインストール可能
- 通常のdjangoと変わらず利用できるので学習コストが低い
  - 単純なCRUDだけなら、30分ほどで新規APIが実装できる
- 開発したAPIをすぐに試せる、APIのテスト画面を提供する

---

djangoでのwebアプリケーション構成図
==



---

djangoでのアプリ開発の流れ
==
- djangoのインストール
- プロジェクトとアプリケーション作成
- モデル作成
  - モデル＝データベースのこと
- ビュー作成
  - URLにアクセスされたときの、返すレスポンスを決める
- ルーティング設定
  - URLと、ビューを紐付ける
- django起動

---

djangoを使ってみよう
==
- cloud9を起動して、Terminal起動
- djangoテスト用ディレクトリ作成
```
mkdir hogebot
```
- テスト用ディレクトリに移動
```
cd hogebot 
``` 
- Python仮想環境を作成
```
python3 -m venv venv
``` 
- 仮想環境内に移動
```
source venv/bin/activate
```

---

djangoを使ってみよう
==
- djangoのインストール
```
pip3 install django 
```
- django rest frameworkのインストール
```
pip3 install djangorestframework
```
- インストール確認
```
pip3 list
```

---

プロジェクトとアプリケーションの作成
==
- プロジェクト作成
```
django-admin startproject hogebot 
```
- アプリケーション作成
```
cd hogebot
python3 manage.py startapp api
```
- アプリケーション「api」のディレクトリに移動
```
cd api 
```

---
プロジェクトとアプリケーションとは
==
- 例えばECサイトを作るとき、ECサイト全体をプロジェクトと呼ぶ
- ECサイト内の、商品一覧、決済画面、ユーザー情報など個々の機能のことをアプリケーションと呼ぶ
- 最低、1プロジェクトと１アプリケーションが必要
- 大規模でなければ、１アプリケーションで十分
- 今回は、hogebotプロジェクトを作成、apiというアプリケーションを作成中

---

初期設定
==
- 以下のファイルをcloud9で開く
```
hogepj/hogepj/settings.py
```
- 以下の項目を編集する
  - INSTALLED_APPSリストに以下を追加
  ```
  'testapp'
  ```
  - LANGUAGE_CODEを編集
  ```
  LANGUAGE_CODE='ja'
  ```
- TIME_ZONEを編集
  ```
  TIME_ZONE='Asia/Tokyo'
  ```

--- 

モデルの作成
==
- アプリケーション「api」で使用するデータベースを作成する
- models.pyを編集して以下を追加して、保存
```python
class Quote(models.Model):
    quote = models.TextField()
```
- 今回はdjangoに組み込みのsqlite3を使用するため、データベースの設定は不要
  - もしMySQLやPostgresSQLを使いたい場合はsettings.pyに設定する

---

マイグレーションの実行
==
- マイグレーションとは、モデルのPythonコードからデータベースを作成すること
- 以下を実行する
```
python3 manage.py makemigrate
```


---

デプロイの話
==





---

AWS Lambda簡易講座
==

---

AWS Lambdaとは
==
- サーバを構築せずに、アプリケーションコードを実行出来る仕組み
  - サーバのサイジングや構築など、サーバ周りの作業が一切不要
 - アプリケーション作成者が、アプリのロジックだけに専念できる
 - Lambdaファンクションを直接動かすことはAWSコンソールからしかできないため、利用するにはトリガーの設定が必要
   - タイマー、AWSの各種イベント、webAPIへのアクセス、など
 - 実行された回数と実行時間に対してのみ課金される
   - 月100万回の呼び出しまでは無料
   - 月40万秒までの実行時間に対しては無料（デフォルト設定の場合）

---

Lambdaの利用例
==
### チャットボットへの定期投稿
- タイマーをトリガーにして、定期的にtocaroなどに投稿する
### AWSリソースの異常通知
- cloudwatchイベントをトリガーにして、異常状態がしきい値を超えたらメール通知するなど
### ログの整形と保存処理
- AWS kinesisと組み合わせて、受信したログを整形してデータベースなどに配置する

---

Lambdaへのコードの配置とテスト方法
==

### 実演しますので、試してみたい方は手元の環境でやってみてください


---

企画アドバイスコーナー
==
- 各チームの企画についてアドバイスさせていただきます
> 資料を手抜きしたかったわけではありません




---
アプリケーションとデータベースの関係
==
- アプリケーションは、必ずなにかしらのデータを扱っている
  - 商品情報とか、買い物かごの中身とか、在庫情報とか、顧客情報とか・・・
- データは、データベースに置かれる
- データベースを直接操作しても、情報を扱うことはできる
  - SQL文を駆使して、欲しい商品を探し出して買い物かごに入れることは出来るだろう
- でも、それでは扱いにくい！uuu
- データベー1kk11uuuuuu{uuuuスの操作をさせつつ、人間が操作しやすい画面を提供するソフトウェアがあればよいのでは＝アプリケーションの誕生
### アプリケーションとは、データベースを扱いやすくするためのもの

---

